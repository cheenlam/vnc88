<div class="contBox-min broadcast" id="page">
    <!-- liveBox start -->
    <div class="liveBox">
        <div class="liveTitle">
            <div>
                <img :src="liveData.title.img">
                <span>{{liveData.title.txt}}</span>
            </div>
        </div>

        <div class="liveList">
            <ul>
                <li v-for="(item,index) in liveList">
                    <div>
                        <div class="liveList_mv">
                            <iframe :src="reMvsrc(item.videoId)" frameborder="0"></iframe>
                        </div>
                        <div class="liveList_msg"> {{item.title}}</div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="liveBtn">
            <div class="btn_linear_c2 btn">
                <div class="btn_cnt">Xem tất cả</div>
            </div>
        </div>
    </div>

    <div class="videoBanner">
        <img :src="liveData.banner.main">
    </div>
    <div class="mainMsg">
        <div class="mainMsg-title">VIDEO</div>
        <!-- videoBox start -->
        <div class="videoBox">
            <div class="gameShow" id="gameShow">
                <div class="main">
                    <iframe :src="reMvsrc(ytShow)" frameborder="0" id="showMv"></iframe>
                </div>
                <div class="list">
                    <div class="arrow_l"></div>
                    <div class="arrow_r"></div>
                    <div class="listArray" id="listArray">
                        <ul>
                            <template v-for="(item,index) in ytList">
                                <li  @click="chYT(item)">
                                    <div>
                                        <div class="listArray_img">
                                            <img :src="item.imgUrl">
                                        </div>
                                        <div class="listArray_msg">
                                            <span>{{item.time}}</span>
                                            <p>{{item.title}}</p>     
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="gameMsg" id="gameMsg">
                <div class="mainMsg-title">BẢNG XẾP HẠNG</div>
                <div class="gameChart">
                    <select @change="chart_list(),goTop()" v-model="selected">
                        <option v-for="(item,index) in chartSel" :value="item.id">{{item.name}}</option>
                    </select>

                    <div class="gameChart_tb"  ref="gameChart">
                        <table>
                            <tr>
                                <th>TT</th>
                                <th>Đội</th>
                                <th>Trận</th>
                                <th>HS</th>
                                <th>Điểm</th>
                            </tr>
                            <tr v-for="(item,index) in chartList">
                                <td>{{index+1}}</td>
                                <td>
                                    <div class="flag">
                                        <img :src="item.img">
                                    </div>
                                    <span>{{item.Team}}</span>
                                </td>
                                <td>{{item.Battle}}</td>
                                <td>{{item.Difference}}</td>
                                <td>{{item.Point}}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="mainMsg-title">Kết quả</div>
                <div class="gameSchedule">
                    <div class="gameSchedule_tb">
                        <table>
                            <template v-for="(item,index) in schedule">
                                <tr>
                                    <th colspan="3">{{item.sort}}</th>
                                </tr>
                                <tr v-for="(item,index) in item.list">
                                    <td>
                                        <div class="club_1">
                                            <span>{{item.club_1_name}}</span>
                                            <div class="badge">
                                                <img :src="item.club_1_badge">
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="time">{{item.time}}</span>
                                    </td>
                                    <td>
                                        <div class="club_2">
                                            <div class="badge">
                                                <img  :src="item.club_2_badge">
                                            </div>
                                            <span>{{item.club_2_name}}</span>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- chatBox start (聊天室) -->
        <div class="chatBox">
            <div class="chatroom">
                <div class="chat_title">聊天室</div>
                <div class="chat_list" id="chat_list">
                    <div id="chat_sc">
                        <ul></ul>
                    </div>
                </div>
                <div class="chat_ipt" id="chat_ipt">
                    <div class="chat_txt">
                        <div class="chat_msg" id="chat_msg" contenteditable="true"></div>
                        <span class="chat_take" disabled>Message</span>
                    </div>
                    <div class="chat_iconBtn" id="chat_iconBtn">
                        <div class="chat_iconList" id="chat_iconList">
                            <ul>
                                <li v-for="(item,index) in liveData.chatIcon">
                                    <img :src="item" class="chat_icon">
                                </li>
                            </ul>
                        </div>
                    </div>

                    <input type="color" class="chat_color" id="chat_color"></input>
                </div>
            </div>

            <div class="chatAd">
                <ul>
                    <li v-for="(item,index) in liveData.banner.ad">
                        <img :src="item">
                    </li>
                </ul>
            </div>
        </div>

        <!-- scheduleList start (時程表) -->
        <div class="scheduleList">
            <div class="mainMsg-title">LỊCH THI ĐẤU</div>
            <!-- dateList -->
            <div class="dateList">
                <div class="today">{{formatDate(today)}}</div>
                <ul>
                    <li v-for="(item,index) in weekList">
                        <div class="date_num">{{item.num}}</div>
                        <div class="date_week">{{item.week}}</div>
                    </li>
                </ul>
            </div>

            <!-- matchList -->
            <div class="matchList">
                <table>
                    <template v-for="(item,index) in schedule">
                        <tr v-for="(item,index) in item.list">
                            <td>
                                <div class="match_title"  :class="{'on':item.live}">
                                    <div class="match_time">
                                        <p>{{item.day}} - {{item.time}}</p>
                                        <div class="match_live">live</div>
                                    </div>
                                    <p>{{item.saibe}}</p>
                                </div>
                            </td>
                            <td>
                                <div class="match_teams">
                                    <div class="team team_L">
                                        <span>{{item.club_1_name}}</span>
                                        <div class="team_flag">
                                            <img :src="item.club_1_badge">
                                        </div>                            
                                    </div>
                                    <div class="vs">VS</div>
                                    <div class="team team_R">
                                        <div class="team_flag">
                                            <img :src="item.club_2_badge">
                                        </div>
                                        <span>{{item.club_2_name}}</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </template>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="js/index.js"></script>
<script>
    Vue.createApp({
        data() {
            return {
                liveData: mvLive,
                liveList: [],
                ytShow: '',
                ytList: [],
                today: '',
                weekList: [],
                selected:'champions-league',
                chartSel:'',
                chartList:'',
               
                // 暫定假資料
                schedule: scheduleData,
            };
        },
        methods: {
            goTop(){
                this.$refs.gameChart.scrollTop = 0;
            },
            reMvsrc(data) {
                return `https://www.youtube.com/embed/${data}`
            },
            getLive() {
                let self = this;
                docRef.get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        let data = doc.data();
                        self.liveList.push(data);
                    });
                })
            },
            getYt() {
                let self = this;
                docRef2.get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        let data = doc.data();
                        self.ytList.push(data);
                        self.ytShow = self.ytList[0].videoId;
                    });
                })
            },
            chYT(data) {
                this.ytShow = data.videoId;
            },
            showDate() {
                this.today = new Date();
                let today = new Date();
                let scheduleWeek = []
                let scheduleNum = []
                var weekTxt = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
                scheduleWeek[3] = weekTxt[new Date().getDay()];
                scheduleNum[3] = new Date().getDate();

                for (let i = 1; i < 4; i++) {
                    let week = [];
                    for (let k = 0; k < 4; k++) {
                        week[k] = new Date()
                    };
                    let getWeek_cut = weekTxt[new Date(week[0].setDate(week[0].getDate() - i)).getDay()];
                    let getWeek_plus = weekTxt[new Date(week[1].setDate(week[1].getDate() + i)).getDay()];
                    let getNum_cut = new Date(week[2].setDate(week[2].getDate() - i)).getDate();
                    let getNum_plus = new Date(week[3].setDate(week[3].getDate() + i)).getDate();
                    scheduleWeek[3 - i] = getWeek_cut;
                    scheduleWeek[3 + i] = getWeek_plus;
                    scheduleNum[3 - i] = getNum_cut;
                    scheduleNum[3 + i] = getNum_plus;
                }

                for (let i = 0; i < scheduleWeek.length; i++) {
                    this.weekList.push({
                        week: scheduleWeek[i],
                        num: scheduleNum[i]
                    })
                }
            },
            formatDate(data) {
                let d = new Date(data)
                let formatd = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
                return formatd;
            },
            chart_sel(){
                let self = this;  
                $.ajax({
                    url: "https://vnc88.awgstudio.com/api/match/score",
                    dataType: "json",
                    success: function(data) {                        
                       self.chartSel = data;
                    },
                });
            },
            chart_list(){
                let self = this;  
                let setUrl = `https://vnc88.awgstudio.com/api/match/score/${self.selected}`
                $.ajax({
                    url: setUrl,
                    dataType: "json",
                    success: function(data) {                        
                       self.chartList = data;
                    },
                });
            }
        },
        mounted() {
            this.getLive();
            this.getYt();
            this.showDate();
            this.chart_sel();
            this.chart_list();
        },
    }).mount("#page");

    // ==========================================================
    // yt影片清單控制
    var arrayNum = 0;
    var movieArray = []
    $('#gameShow .arrow_l').click(function() {
        arrayNum == 0 ? 0 : arrayNum--;
        $('#listArray ul').css('transform', `translateX(-${arrayNum*23}%)`)
    })

    $('#gameShow .arrow_r').click(function() {
        arrayNum == 3 ? 3 : arrayNum++;
        $('#listArray ul').css('transform', `translateX(-${arrayNum*23}%)`)
    })

    // 聊天室
    var databaseMs = new Date().getTime()
    database.on('value', function(snapshot) {
        var getData = snapshot.val()
        var txt = ''
        for (let i in getData) {
            let msg = getData[i].msg.split('<div>').join('').split('</div>').join('').replace('<br>', '');

            txt += `<li class="${getData[i].id == 'id' + databaseMs?'self':''}" >
                        <div class="chat_member">
                            <span class="chat_time" id="chat_time">${getData[i].time}</span>
                            <span class="chat_name" id="chat_name">${getData[i].name}</span>
                        </div>
                        <div class="chat_speak" id="chat_speak" style="color:${getData[i].color}">${msg}</div>
                    </li>`
        }

        $('#chat_list ul').html(txt)

        var chat_sc = document.getElementById('chat_sc');
        chat_sc.scrollTop = chat_sc.scrollHeight;
    });

    var chat_ipt = false
    $('#chat_msg').focus(function() {
        chat_ipt = true
    }).blur(function() {
        chat_ipt = false
    })

    $(document).keydown(function(e) {
        if (e.keyCode == 13 && chat_ipt) {
            write();
        }
    });

    // 加入icon圖片
    $('#chat_iconList li').click(function() {
        let getIndex = $('#chat_iconList li').index(this);
        $('#chat_msg').append(`<img src="images/icon/i_chat_${getIndex+1}.png" class="chat_icon">`);
        $('#chat_msg').focus();
        showTake();
    })

    $('#chat_msg').focus(function() {
        $(document).keydown(function(e) {
            showTake();

        });
    })

    function showTake() {
        let state = $('#chat_msg').html().length;
        if (state >= 1) {
            $('.chat_take').css('display', 'none');
        } else {
            $('.chat_take').css('display', 'flex');
        }
    }

    function write() {
        var date = new Date();
        var h = date.getHours();
        var m = date.getMinutes();
        var s = date.getSeconds();
        if (h < 10) {
            h = '0' + h;
        }
        if (m < 10) {
            m = '0' + m;
        }
        var now = h + ':' + m
        var getMsg = $('#chat_msg').html().split('<div>').join('').split('</div>').join('').replace('<br>', '')
        var postData = {
            name: '匿名',
            msg: getMsg,
            time: now,
            id: 'id' + databaseMs,
            color: $('#chat_color').val()
        };

        firebase.database().ref().push(postData);
        $('#chat_msg').attr('contenteditable', "false")
        $('#chat_msg').html('')
        $('#chat_msg').attr('contenteditable', "true");
        setTimeout(function() {
            $('#chat_msg').focus();
        }, 100)
    }
</script>
